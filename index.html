<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึก OT & เงินเดือน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script>
        // --- LocalStorage Manager ---
        const DB_KEY_RECORDS = 'ot_tracker_records_v2';
        const DB_KEY_SETTINGS = 'ot_tracker_settings_v2';

        const defaultSettings = { baseSalary: 15000, workDays: 30, workHours: 8 };

        function loadData() {
            const savedRecords = localStorage.getItem(DB_KEY_RECORDS);
            const savedSettings = localStorage.getItem(DB_KEY_SETTINGS);
            
            return {
                records: savedRecords ? JSON.parse(savedRecords) : [],
                settings: savedSettings ? JSON.parse(savedSettings) : defaultSettings
            };
        }

        function saveData(records, settings) {
            if(records) localStorage.setItem(DB_KEY_RECORDS, JSON.stringify(records));
            if(settings) localStorage.setItem(DB_KEY_SETTINGS, JSON.stringify(settings));
        }
    </script>

    <style>
        body { font-family: 'Anuphan', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

    <!-- Main Content -->
    <div id="main-content" class="max-w-md mx-auto p-4">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-6 pt-2">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Salary Tracker</h1>
                <p class="text-sm text-slate-500">บันทึกรายได้และโอที</p>
            </div>
            <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                <i data-lucide="cloud" class="w-3 h-3"></i>
                GitHub Pages
            </div>
        </header>

        <!-- Summary Card -->
        <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 text-white shadow-xl shadow-blue-200 mb-6 relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-blue-100 text-sm font-medium">ยอดรวมเดือนนี้ (ประมาณการ)</p>
                    <span class="bg-white/20 px-2 py-0.5 rounded text-xs backdrop-blur-sm" id="current-month-label">-</span>
                </div>
                <h2 class="text-4xl font-bold mb-6 tracking-tight">฿<span id="display-total">0</span></h2>
                
                <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                    <div>
                        <p class="text-blue-200 text-xs mb-1">เงินเดือน</p>
                        <p class="font-semibold text-lg">฿<span id="display-base-salary">0</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-blue-200 text-xs mb-1">ค่า OT สะสม</p>
                        <p class="font-semibold text-lg text-green-300">+฿<span id="display-ot-pay">0</span></p>
                    </div>
                </div>
            </div>
            <!-- Decoration -->
            <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
        </div>

        <!-- Quick Stats & Settings -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                    </div>
                    <span class="text-xs text-slate-500">ชั่วโมง OT</span>
                </div>
                <p class="font-bold text-xl text-slate-800"><span id="display-ot-hours">0</span> <span class="text-sm font-normal text-slate-400">ชม.</span></p>
            </div>
            <button onclick="openSettings()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-center hover:bg-slate-50 transition-colors text-left">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 bg-slate-100 text-slate-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="settings-2" class="w-4 h-4"></i>
                    </div>
                    <span class="text-xs text-slate-500">ตั้งค่า</span>
                </div>
                <p class="font-bold text-xl text-slate-800">แก้ไข <span class="text-sm font-normal text-slate-400">ฐานเงินเดือน</span></p>
            </button>
        </div>

        <!-- Add OT Form -->
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-5 h-5 text-blue-500"></i>
                บันทึก OT
            </h3>
            <form onsubmit="handleAddOT(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">วันที่</label>
                        <input type="date" id="date-input" name="date" required onchange="updateDatePreview(this.value)"
                            class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <div id="date-preview" class="text-xs text-blue-600 mt-1.5 font-medium hidden"></div>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">จำนวนชม.</label>
                        <input type="number" step="0.5" name="hours" placeholder="0.0" required 
                            class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">ประเภท (ตัวคูณ)</label>
                    <div class="relative">
                        <select name="multiplier" class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                            <option value="1.5">OT 1.5 เท่า (หลังเลิกงาน)</option>
                            <option value="2">OT 2.0 เท่า (วันหยุด)</option>
                            <option value="3">OT 3.0 เท่า (นักขัตฤกษ์)</option>
                            <option value="1">1.0 เท่า (ชั่วโมงปกติ)</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-200">
                    บันทึกรายการ
                </button>
            </form>
        </div>

        <!-- History List -->
        <div>
            <div class="flex items-center justify-between mb-3 px-1">
                <h3 class="font-bold text-slate-800">รายการล่าสุด</h3>
                <span class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded-md cursor-pointer hover:bg-red-100 transition-colors" onclick="confirmClearAll()">ล้างข้อมูลทั้งหมด</span>
            </div>
            <div id="history-list" class="space-y-3 pb-8">
                <!-- Javascript will populate this -->
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <dialog id="modal-settings" class="modal p-0 rounded-3xl glass shadow-2xl w-full max-w-sm mx-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg">ตั้งค่าการคำนวณ</h3>
                <button onclick="document.getElementById('modal-settings').close()" class="w-8 h-8 flex items-center justify-center hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="handleSaveSettings(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">เงินเดือนพื้นฐาน</label>
                    <input type="number" name="baseSalary" id="setting-salary" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-800">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">วันทำงาน/เดือน</label>
                        <input type="number" name="workDays" id="setting-days" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">ชม.ทำงาน/วัน</label>
                        <input type="number" name="workHours" id="setting-hours" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl mt-2">บันทึก</button>
            </form>
        </div>
    </dialog>

    <!-- Modal: Confirm Delete -->
    <dialog id="modal-delete" class="modal p-6 rounded-3xl glass shadow-2xl w-full max-w-sm mx-auto">
        <div class="text-center">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="trash-2" class="w-6 h-6"></i>
            </div>
            <h3 class="font-bold text-lg text-slate-800 mb-2">ลบรายการนี้?</h3>
            <p class="text-slate-500 text-sm mb-6">ข้อมูลจะหายไปและกู้คืนไม่ได้</p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('modal-delete').close()" class="py-3 rounded-xl bg-slate-100 text-slate-700 font-bold hover:bg-slate-200 transition-colors">
                    ยกเลิก
                </button>
                <button onclick="executeDelete()" class="py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-200">
                    ลบเลย
                </button>
            </div>
        </div>
    </dialog>

    <script>
        // --- App Logic ---
        let appData = { records: [], settings: {} };
        let recordToDeleteId = null; // Store ID for deletion

        function formatThaiDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        window.updateDatePreview = (val) => {
            const el = document.getElementById('date-preview');
            if (val) {
                el.textContent = `เลือก: ${formatThaiDate(val)}`;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        function init() {
            appData = loadData();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
            updateDatePreview(today);
            
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            document.getElementById('current-month-label').textContent = months[new Date().getMonth()];

            lucide.createIcons();
            render();
        }

        function calculate() {
            const { baseSalary, workDays, workHours } = appData.settings;
            const hourlyRate = baseSalary / (workDays * workHours);
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyRecords = appData.records.filter(r => {
                const d = new Date(r.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });

            let totalOT = 0;
            let totalHours = 0;
            monthlyRecords.forEach(r => {
                totalHours += r.hours;
                totalOT += r.hours * hourlyRate * r.multiplier;
            });

            return {
                base: baseSalary,
                ot: totalOT,
                total: baseSalary + totalOT,
                hours: totalHours,
                hourlyRate: hourlyRate
            };
        }

        function render() {
            const result = calculate();

            document.getElementById('display-base-salary').textContent = result.base.toLocaleString();
            document.getElementById('display-ot-pay').textContent = result.ot.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('display-total').textContent = result.total.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('display-ot-hours').textContent = result.hours;

            const list = document.getElementById('history-list');
            if (appData.records.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-50"><i data-lucide="clipboard-list" class="w-12 h-12 mx-auto mb-2 text-slate-300"></i><p class="text-sm text-slate-400">ยังไม่มีรายการ</p></div>`;
            } else {
                const sortedRecords = [...appData.records].sort((a, b) => new Date(b.date) - new Date(a.date));
                list.innerHTML = sortedRecords.map((r, index) => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-100 shadow-sm slide-up" style="animation-delay: ${index * 0.05}s">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs">
                                ${new Date(r.date).getDate()}
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm">${formatThaiDate(r.date)}</p>
                                <p class="text-xs text-slate-500">${r.hours} ชม. × ${r.multiplier}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-green-600 text-sm">+${(r.hours * result.hourlyRate * r.multiplier).toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                            <button onclick="askDelete(${r.id})" class="text-[10px] text-red-400 hover:text-red-600 mt-1 p-1">ลบ</button>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function handleAddOT(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newRecord = {
                id: Date.now(),
                date: formData.get('date'),
                hours: Number(formData.get('hours')),
                multiplier: Number(formData.get('multiplier'))
            };
            appData.records.push(newRecord);
            saveData(appData.records, null);
            e.target.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
            updateDatePreview(today);
            render();
        }

        // --- Delete Logic (Modal) ---
        function askDelete(id) {
            recordToDeleteId = id;
            document.getElementById('modal-delete').showModal();
        }

        function executeDelete() {
            if (recordToDeleteId) {
                appData.records = appData.records.filter(r => r.id !== recordToDeleteId);
                saveData(appData.records, null);
                render();
            }
            document.getElementById('modal-delete').close();
            recordToDeleteId = null;
        }

        function confirmClearAll() {
            if(confirm('ระวัง! ข้อมูลทั้งหมดจะหายไป ยืนยันไหม?')) {
                localStorage.clear();
                appData = loadData();
                render();
            }
        }

        // --- Settings Logic ---
        function openSettings() {
            document.getElementById('setting-salary').value = appData.settings.baseSalary;
            document.getElementById('setting-days').value = appData.settings.workDays;
            document.getElementById('setting-hours').value = appData.settings.workHours;
            document.getElementById('modal-settings').showModal();
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            appData.settings = {
                baseSalary: Number(formData.get('baseSalary')),
                workDays: Number(formData.get('workDays')),
                workHours: Number(formData.get('workHours'))
            };
            saveData(null, appData.settings);
            document.getElementById('modal-settings').close();
            render();
        }

        window.onload = init;
    </script>
</body>
</html>
